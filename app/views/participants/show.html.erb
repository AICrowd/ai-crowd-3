<%
  active_tab = params[:tab]
  active_tab = 'insights' unless ['teams','bio'].include?(active_tab)
%>

<%= render partial: 'masthead', locals: { participant: @participant } %>

<!-- sub-nav bar -->
<div class="sub-nav-bar sticky-top">
  <div class="container-fluid">
    <ul class="nav tabs">
      <li class="nav-item">
        <a class="nav-link nav-link-01<%= ' active' if active_tab == 'insights' %>" data-toggle='tab' href="#tab-insights" onclick="return false;">Insights</a>
      </li>
      <li class="nav-item">
        <a class="nav-link nav-link-02<%= ' active' if active_tab == 'teams' %>" data-toggle='tab' href="#tab-teams" onclick="return false;">Teams</a>
      </li>
      <li class="nav-item">
        <a class="nav-link nav-link-03<%= ' active' if active_tab == 'posts' %>" data-toggle='tab' href="#tab-posts" onclick="return false;">Posts</a>
      </li>
      <li class="nav-item">
        <a class="nav-link nav-link-04<%= ' active' if active_tab == 'bio' %>" data-toggle='tab' href="#tab-bio" onclick="return false;">Bio</a>
      </li>
      <!-- more dropdown xs -->
      <li class="nav-item dropdown more-xs">
        <a class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" role="button" aria-haspopup="true" aria-expanded="false"><svg width="16" height="4" xmlns="http://www.w3.org/2000/svg"><path d="M2 0C.9 0 0 .9 0 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zM8 0C6.9 0 6 .9 6 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" fill="#5D5F60" fill-rule="nonzero"/></svg></a>
        <div class="dropdown-menu dropdown-menu-right">
          <a class="dropdown-item" href="#">Bio</a>
        </div>
      </li>
      <!-- /more dropdown xs -->
    </ul>
  </div>
</div>
<!-- /sub-nav bar -->

<div class="tab-content">
  <div id='tab-insights' class="tab-pane fade<%= ' show active' if active_tab == 'insights' %>">
    <!-- section -->
    <section class="section-p-md">
      <div class="container-fluid">
        <div class="row">
          <div class="col-8">
            <header class="section-header-decorative">
              <div>
                <h4>Ratings Progression</h4>
              </div>
            </header>
            <%= line_chart @participant.user_rating_history, id: "line-chart" %>
          </div>
          <div class="col-4">
            <header class="section-header-decorative">
              <div>
                <h4>Challenge Categories</h4>
              </div>
            </header>
            <%= pie_chart @categories, colors: ["#FF8C00", "#FFD700", "#6B8E23", "#FFEBCD", "#00FF00", 
              "#228B22", "#800000", "#32CD32", "#B8860B", "#9966CC"] %>
          </div>
        </div>
      </div>
    </section>
    <!-- /section -->
    <% if @challenges.any? %>
      <section class="section-p-md">
        <div class="container-fluid">
          <header class="section-header-decorative">
            <div>
              <h4>Challenges Entered</h4>
            </div>
          </header>
          <div class="container">
            <%= render partial: 'challenge_list', locals: { challenges: @challenges, participant: @participant } %>
          </div>
        </div>
      </section>
    <% end %>
  </div>

  <div id="tab-teams" class="tab-pane fade<%= ' show active' if active_tab == 'teams' %>">
    <%= render partial: 'teams_list' %>
  </div>

  <div id="tab-posts" class="tab-pane fade<%= ' show active' if active_tab == 'posts' %>">
    <%= render partial: 'discourse_posts_list', locals: { participant: @participant, discourse_posts_fetch: @discourse_posts_fetch, discourse_posts: @discourse_posts } %>
  </div>

  <div id='tab-bio' class="tab-pane fade<%= ' show active' if active_tab == 'bio' %>">
  <!-- section -->
    <section class="section-p-md">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12">
            <div class="md-content">
              <% if @participant.bio.present? %>
                <%= @participant.bio %>
              <% else %>
                <%= "#{@participant.name} has not provided any information yet." %>
              <% end %>
            </div>

          </div>
        </div>
      </div>
    </section>
    <!-- /section -->
  </div>
</div>
<script>
    function indexOfArray(val, array) {
        for(i = 0; i < array.length; i++) {
            if (array[i][1] == val) {
                return i
            }
        }
    };
    var chart = Chartkick.charts["line-chart"];
    var newOptions = {
        library: {
            tooltips: {
                callbacks: {
                    label: function(tooltipItem, data) {
                        challenge_round_name = chart.dataSource[indexOfArray(tooltipItem.yLabel, chart.dataSource)][2]
                        if(challenge_round_name == '') {
                            return tooltipItem.yLabel
                        }
                        return tooltipItem.yLabel + "\nchallenge round name:" + challenge_round_name;

                    }
                }
            }
        }
    };
    var mergedOptions = jQuery.extend(chart.options,newOptions);
    chart.setOptions(mergedOptions);
    pointarray = new Array(chart.chart.data.datasets[0].data.length).fill(0)
    data_array = chart.chart.data.datasets[0].data
    for(j in data_array) {
        challenge_round_name = chart.dataSource[indexOfArray(data_array[j], chart.dataSource)][2]
        if(challenge_round_name != '') {
            pointarray[j] = 4
        }
    }
    chart.chart.data.datasets[0].pointRadius = pointarray
    chart.chart.update()
</script>
